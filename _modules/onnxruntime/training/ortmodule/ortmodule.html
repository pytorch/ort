


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>onnxruntime.training.ortmodule.ortmodule &mdash; ONNX Runtime for PyTorch latest documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
  <!-- Google Analytics -->
  
  <!-- End Google Analytics -->
  

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/audio/stable/index.html">
                  <span class="dropdown-title">torchaudio</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/text/stable/index.html">
                  <span class="dropdown-title">torchtext</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/vision/stable/index.html">
                  <span class="dropdown-title">torchvision</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchrec">
                  <span class="dropdown-title">TorchRec</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/data">
                  <span class="dropdown-title">TorchData</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/serve/">
                  <span class="dropdown-title">TorchServe</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchx/">
                  <span class="dropdown-title">TorchX</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/xla">
                  <span class="dropdown-title">PyTorch on XLA Devices</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about PyTorchâ€™s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/hub">
                  <span class="dropdown-title">Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
                <div class="version">
                  latest
                </div>
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../ortmodule.html">ORTModule</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install.html">Install torch-ort</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../../index.html">Module code</a> &gt;</li>
        
      <li>onnxruntime.training.ortmodule.ortmodule</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for onnxruntime.training.ortmodule.ortmodule</h1><div class="highlight"><pre>
<span></span><span class="c1"># -------------------------------------------------------------------------</span>
<span class="c1"># Copyright (c) Microsoft Corporation. All rights reserved.</span>
<span class="c1"># Licensed under the MIT License.</span>
<span class="c1"># --------------------------------------------------------------------------</span>

<span class="kn">from</span> <span class="nn">._torch_module_factory</span> <span class="kn">import</span> <span class="n">TorchModuleFactory</span>
<span class="kn">from</span> <span class="nn">._torch_module_pytorch</span> <span class="kn">import</span> <span class="n">TorchModulePytorch</span>
<span class="kn">from</span> <span class="nn">._torch_module_ort</span> <span class="kn">import</span> <span class="n">TorchModuleORT</span>
<span class="kn">from</span> <span class="nn">._custom_op_symbolic_registry</span> <span class="kn">import</span> <span class="n">CustomOpSymbolicRegistry</span>
<span class="kn">from</span> <span class="nn">._custom_gradient_registry</span> <span class="kn">import</span> <span class="n">CustomGradientRegistry</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_utils</span>
<span class="kn">from</span> <span class="nn">.debug_options</span> <span class="kn">import</span> <span class="n">DebugOptions</span>
<span class="kn">from</span> <span class="nn">._fallback</span> <span class="kn">import</span> <span class="n">_FallbackManager</span><span class="p">,</span> <span class="n">_FallbackPolicy</span><span class="p">,</span> <span class="n">ORTModuleFallbackException</span>
<span class="kn">from</span> <span class="nn">onnxruntime.training</span> <span class="kn">import</span> <span class="n">ortmodule</span>

<span class="kn">from</span> <span class="nn">onnxruntime.tools</span> <span class="kn">import</span> <span class="n">pytorch_export_contrib_ops</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Callable</span>


<span class="c1"># Needed to override PyTorch methods</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s2">&quot;Module&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="ORTModule"><a class="viewcode-back" href="../../../../ortmodule.html#torch_ort.ORTModule">[docs]</a><span class="k">class</span> <span class="nc">ORTModule</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extends user&#39;s :class:`torch.nn.Module` model to leverage ONNX Runtime super fast training engine.</span>

<span class="sd">    ORTModule specializes the user&#39;s :class:`torch.nn.Module` model, providing :meth:`~torch.nn.Module.forward`,</span>
<span class="sd">    :meth:`~torch.nn.Module.backward` along with all others :class:`torch.nn.Module`&#39;s APIs.</span>

<span class="sd">    Args:</span>
<span class="sd">        module (torch.nn.Module): User&#39;s PyTorch module that ORTModule specializes</span>
<span class="sd">        debug_options (:obj:`DebugOptions`, optional): debugging options for ORTModule.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">debug_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># NOTE: torch.nn.Modules that call setattr on their internal attributes regularly</span>
        <span class="c1">#       (for example PyTorch Lightning), will trigger regular re-exports. This is</span>
        <span class="c1">#       because ORTModule auto detects such setattrs on the original module and</span>
        <span class="c1">#       marks the model as stale. This is a known limitation. To disable repeated</span>
        <span class="c1">#       re-export checks when not required, please set the environment variable</span>
        <span class="c1">#       ORTMODULE_SKIPCHECK_POLICY to SKIP_CHECK_BUILD_GRADIENT|SKIP_CHECK_EXECUTION_AGENT</span>

        <span class="c1"># Set _is_initialized attribute first which starts off as False.</span>
        <span class="c1"># This variable will be used for comparing strings in __setattr__ and __getattr__</span>
        <span class="c1"># NOTE: Do not rename/move.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Python default arguments are evaluated on function definition</span>
        <span class="c1"># and not on function invocation. So, if debug_options is not provided,</span>
        <span class="c1"># instantiate it inside the function.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">debug_options</span><span class="p">:</span>
            <span class="n">debug_options</span> <span class="o">=</span> <span class="n">DebugOptions</span><span class="p">()</span>

        <span class="c1"># Fallback settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fallback_manager</span> <span class="o">=</span> <span class="n">_FallbackManager</span><span class="p">(</span>
            <span class="n">pytorch_module</span><span class="o">=</span><span class="n">module</span><span class="p">,</span> <span class="n">policy</span><span class="o">=</span><span class="n">ortmodule</span><span class="o">.</span><span class="n">ORTMODULE_FALLBACK_POLICY</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="n">ortmodule</span><span class="o">.</span><span class="n">ORTMODULE_FALLBACK_RETRY</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Read ORTModule module initialization status</span>
            <span class="k">if</span> <span class="n">ortmodule</span><span class="o">.</span><span class="n">_FALLBACK_INIT_EXCEPTION</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ortmodule</span><span class="o">.</span><span class="n">_FALLBACK_INIT_EXCEPTION</span>

            <span class="nb">super</span><span class="p">(</span><span class="n">ORTModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span> <span class="o">=</span> <span class="n">TorchModuleFactory</span><span class="p">()(</span><span class="n">module</span><span class="p">,</span> <span class="n">debug_options</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fallback_manager</span><span class="p">)</span>

            <span class="n">_utils</span><span class="o">.</span><span class="n">patch_ortmodule_forward_method</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="c1"># Support contrib OPs</span>
            <span class="n">pytorch_export_contrib_ops</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
            <span class="n">CustomOpSymbolicRegistry</span><span class="o">.</span><span class="n">register_all</span><span class="p">()</span>
            <span class="n">CustomGradientRegistry</span><span class="o">.</span><span class="n">register_all</span><span class="p">()</span>

            <span class="c1"># Warn user if there are name collisions between user model&#39;s and ORTModule attributes</span>
            <span class="c1"># And if there are custom methods defined on the user&#39;s model, copy and bind them to</span>
            <span class="c1"># ORTModule.</span>
            <span class="n">_utils</span><span class="o">.</span><span class="n">check_for_name_collisions_and_bind_methods_to_ortmodule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">ORTModuleFallbackException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Although backend is switched to PyTorch here,</span>
            <span class="c1"># it is up to _FallbackManager to actually terminate execution or fallback</span>
            <span class="n">_utils</span><span class="o">.</span><span class="n">switch_backend_to_pytorch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>

            <span class="c1"># Exceptions subject to fallback are handled here</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fallback_manager</span><span class="o">.</span><span class="n">handle_exception</span><span class="p">(</span><span class="n">exception</span><span class="o">=</span><span class="n">e</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">debug_options</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Although backend is switched to PyTorch here,</span>
            <span class="c1"># it is up to _FallbackManager to actually terminate execution or fallback</span>
            <span class="n">_utils</span><span class="o">.</span><span class="n">switch_backend_to_pytorch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>

            <span class="c1"># Catch-all FALLBACK_FORCE_TORCH_FORWARD fallback is handled here</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fallback_manager</span><span class="o">.</span><span class="n">handle_exception</span><span class="p">(</span>
                <span class="n">exception</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
                <span class="n">log_level</span><span class="o">=</span><span class="n">debug_options</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">log_level</span><span class="p">,</span>
                <span class="n">override_policy</span><span class="o">=</span><span class="n">_FallbackPolicy</span><span class="o">.</span><span class="n">FALLBACK_FORCE_TORCH_FORWARD</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">training</span><span class="p">)</span>
        <span class="c1"># Finally, ORTModule initialization is complete.</span>
        <span class="c1"># Assign self._is_initialized to True after all the ORTModule class attributes have been assigned</span>
        <span class="c1"># else, they will be assigned to self._torch_module.original_module instead.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_initialized</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># IMPORTANT: DO NOT add code here</span>
    <span class="c1"># This declaration is for automatic document generation purposes only</span>
    <span class="c1"># The actual forward implementation is bound during ORTModule initialization</span>
<div class="viewcode-block" id="ORTModule.forward"><a class="viewcode-back" href="../../../../ortmodule.html#torch_ort.ORTModule.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">inputs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delegate the :meth:`~torch.nn.Module.forward` pass of PyTorch training to</span>
<span class="sd">        ONNX Runtime.</span>

<span class="sd">        The first call to forward performs setup and checking steps. During this call,</span>
<span class="sd">        ORTModule determines whether the module can be trained with ONNX Runtime. For</span>
<span class="sd">        this reason, the first forward call execution takes longer than subsequent calls.</span>
<span class="sd">        Execution is interupted if ONNX Runtime cannot process the model for training.</span>

<span class="sd">        Args:</span>
<span class="sd">            *inputs and **kwargs represent the positional, variable positional, keyword</span>
<span class="sd">            and variable keyword arguments defined in the user&#39;s PyTorch module&#39;s forward</span>
<span class="sd">            method. Values can be torch tensors and primitive types.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The output as expected from the forward method defined by the user&#39;s</span>
<span class="sd">            PyTorch module. Output values supported include tensors, nested sequences</span>
<span class="sd">            of tensors and nested dictionaries of tensor values.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

    <span class="k">def</span> <span class="nf">_replicate_for_data_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Raises a NotImplementedError exception since ORTModule is not compatible with torch.nn.DataParallel</span>

<span class="sd">        torch.nn.DataParallel requires the model to be replicated across multiple devices, and</span>
<span class="sd">        in this process, ORTModule tries to export the model to onnx on multiple devices with the same</span>
<span class="sd">        sample input. Because of this multiple device export with the same sample input, torch throws an</span>
<span class="sd">        exception that reads: &quot;RuntimeError: Input, output and indices must be on the current device&quot;</span>
<span class="sd">        which can be vague to the user since they might not be aware of what happens behind the scene.</span>

<span class="sd">        We therefore try to preemptively catch use of ORTModule with torch.nn.DataParallel and throw a</span>
<span class="sd">        more meaningful exception.</span>

<span class="sd">        Users must use torch.nn.parallel.DistributedDataParallel instead of torch.nn.DataParallel</span>
<span class="sd">        which does not need model replication and is also recommended by torch to use instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="o">.</span><span class="n">_replicate_for_data_parallel</span><span class="p">()</span>

<div class="viewcode-block" id="ORTModule.add_module"><a class="viewcode-back" href="../../../../ortmodule.html#torch_ort.ORTModule.add_module">[docs]</a>    <span class="k">def</span> <span class="nf">add_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Module&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Raises a ORTModuleTorchModelException exception since ORTModule does not support adding modules to it&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">module</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The original `torch.nn.Module` that this module wraps.</span>

<span class="sd">        This property provides access to methods and properties on the original module.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># HuggingFace Trainer `save_model` method checks to see if the input model is a HuggingFace PreTrainedModel</span>
        <span class="c1"># or if the model has an attribute called `module` which references a HuggingFace PreTrainedModel to save</span>
        <span class="c1"># the entire context of the model so that it can be loaded using HuggingFace `from_pretrained` method.</span>
        <span class="c1"># This `module` property enables HuggingFace Trainer to retrieve the underlying PreTrainedModel inside ORTModule</span>
        <span class="c1"># to save and load a complete checkpoint</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="o">.</span><span class="n">module</span>

    <span class="c1">################################################################################</span>
    <span class="c1"># The methods below are part of torch.nn.Module API that are encapsulated through</span>
    <span class="c1"># TorchModuleInterface</span>
    <span class="c1">################################################################################</span>

    <span class="k">def</span> <span class="nf">_apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override original method to delegate execution to the flattened PyTorch user module&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="o">.</span><span class="n">_apply</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="ORTModule.apply"><a class="viewcode-back" href="../../../../ortmodule.html#torch_ort.ORTModule.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="s2">&quot;Module&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Override :meth:`~torch.nn.Module.apply` to delegate execution to ONNX Runtime&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="k">def</span> <span class="nf">_is_training</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="o">.</span><span class="n">is_training</span><span class="p">()</span>

<div class="viewcode-block" id="ORTModule.train"><a class="viewcode-back" href="../../../../ortmodule.html#torch_ort.ORTModule.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Override :meth:`~torch.nn.Module.train` to delegate execution to ONNX Runtime&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">training</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="c1"># In a torch.nn.Module, _modules stores all dependent modules (sub-modules) of the current module.</span>
        <span class="c1"># in a list so that torch.nn.Module can apply any changes to all sub-modules recursively.</span>
        <span class="c1"># Although the _flattened_module and _original_module are dependent modules for ORTModule,</span>
        <span class="c1"># they do not show up in _modules because they are abstracted away behind another class,</span>
        <span class="c1"># TorchModule. In order to apply changes to those sub-modules, delegate the task to _torch_module</span>
        <span class="c1"># which will recursively update the flattened_module and the original module.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="ORTModule.state_dict"><a class="viewcode-back" href="../../../../ortmodule.html#torch_ort.ORTModule.state_dict">[docs]</a>    <span class="k">def</span> <span class="nf">state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">destination</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">keep_vars</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override :meth:`~torch.nn.Module.state_dict` to delegate execution to ONNX Runtime&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(</span><span class="n">destination</span><span class="o">=</span><span class="n">destination</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">keep_vars</span><span class="o">=</span><span class="n">keep_vars</span><span class="p">)</span></div>

<div class="viewcode-block" id="ORTModule.load_state_dict"><a class="viewcode-back" href="../../../../ortmodule.html#torch_ort.ORTModule.load_state_dict">[docs]</a>    <span class="k">def</span> <span class="nf">load_state_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">:</span> <span class="s2">&quot;OrderedDict[str, Tensor]&quot;</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override :meth:`~torch.nn.Module.load_state_dict` to delegate execution to ONNX Runtime&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">)</span></div>

<div class="viewcode-block" id="ORTModule.register_buffer"><a class="viewcode-back" href="../../../../ortmodule.html#torch_ort.ORTModule.register_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">register_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tensor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">persistent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Override :meth:`~torch.nn.Module.register_buffer`&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tensor</span><span class="p">,</span> <span class="n">persistent</span><span class="o">=</span><span class="n">persistent</span><span class="p">)</span></div>

<div class="viewcode-block" id="ORTModule.register_parameter"><a class="viewcode-back" href="../../../../ortmodule.html#torch_ort.ORTModule.register_parameter">[docs]</a>    <span class="k">def</span> <span class="nf">register_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">param</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Override :meth:`~torch.nn.Module.register_parameter`&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="o">.</span><span class="n">register_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span></div>

<div class="viewcode-block" id="ORTModule.get_parameter"><a class="viewcode-back" href="../../../../ortmodule.html#torch_ort.ORTModule.get_parameter">[docs]</a>    <span class="k">def</span> <span class="nf">get_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Override :meth:`~torch.nn.Module.get_parameter`&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">target</span><span class="p">)</span></div>

<div class="viewcode-block" id="ORTModule.get_buffer"><a class="viewcode-back" href="../../../../ortmodule.html#torch_ort.ORTModule.get_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">get_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Override :meth:`~torch.nn.Module.get_buffer`&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">(</span><span class="n">target</span><span class="p">)</span></div>

<div class="viewcode-block" id="ORTModule.parameters"><a class="viewcode-back" href="../../../../ortmodule.html#torch_ort.ORTModule.parameters">[docs]</a>    <span class="k">def</span> <span class="nf">parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recurse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Override :meth:`~torch.nn.Module.parameters`&quot;&quot;&quot;</span>

        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="o">.</span><span class="n">parameters</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="n">recurse</span><span class="p">)</span></div>

<div class="viewcode-block" id="ORTModule.named_parameters"><a class="viewcode-back" href="../../../../ortmodule.html#torch_ort.ORTModule.named_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">named_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">recurse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Override :meth:`~torch.nn.Module.named_parameters`&quot;&quot;&quot;</span>

        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="n">recurse</span><span class="p">)</span></div>

<div class="viewcode-block" id="ORTModule.buffers"><a class="viewcode-back" href="../../../../ortmodule.html#torch_ort.ORTModule.buffers">[docs]</a>    <span class="k">def</span> <span class="nf">buffers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recurse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Override :meth:`~torch.nn.Module.buffers`&quot;&quot;&quot;</span>

        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="o">.</span><span class="n">buffers</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="n">recurse</span><span class="p">)</span></div>

<div class="viewcode-block" id="ORTModule.named_buffers"><a class="viewcode-back" href="../../../../ortmodule.html#torch_ort.ORTModule.named_buffers">[docs]</a>    <span class="k">def</span> <span class="nf">named_buffers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">recurse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Override :meth:`~torch.nn.Module.named_buffers`&quot;&quot;&quot;</span>

        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="o">.</span><span class="n">named_buffers</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="n">recurse</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_load_from_state_dict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">state_dict</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">local_metadata</span><span class="p">,</span> <span class="n">strict</span><span class="p">,</span> <span class="n">missing_keys</span><span class="p">,</span> <span class="n">unexpected_keys</span><span class="p">,</span> <span class="n">error_msgs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override original method to delegate execution to the original PyTorch user module&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="o">.</span><span class="n">_load_from_state_dict</span><span class="p">(</span>
            <span class="n">state_dict</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">local_metadata</span><span class="p">,</span> <span class="n">strict</span><span class="p">,</span> <span class="n">missing_keys</span><span class="p">,</span> <span class="n">unexpected_keys</span><span class="p">,</span> <span class="n">error_msgs</span>
        <span class="p">)</span>

<div class="viewcode-block" id="ORTModule.named_children"><a class="viewcode-back" href="../../../../ortmodule.html#torch_ort.ORTModule.named_children">[docs]</a>    <span class="k">def</span> <span class="nf">named_children</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;Module&quot;</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Override :meth:`~torch.nn.Module.named_children`&quot;&quot;&quot;</span>

        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="o">.</span><span class="n">named_children</span><span class="p">()</span></div>

<div class="viewcode-block" id="ORTModule.modules"><a class="viewcode-back" href="../../../../ortmodule.html#torch_ort.ORTModule.modules">[docs]</a>    <span class="k">def</span> <span class="nf">modules</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="s2">&quot;Module&quot;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Override :meth:`~torch.nn.Module.modules`&quot;&quot;&quot;</span>

        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="o">.</span><span class="n">modules</span><span class="p">()</span></div>

<div class="viewcode-block" id="ORTModule.named_modules"><a class="viewcode-back" href="../../../../ortmodule.html#torch_ort.ORTModule.named_modules">[docs]</a>    <span class="k">def</span> <span class="nf">named_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Override :meth:`~torch.nn.Module.named_modules`&quot;&quot;&quot;</span>

        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="o">.</span><span class="n">named_modules</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;_is_initialized&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;_is_initialized&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># If ORTModule is initialized and attribute is not found in ORTModule,</span>
            <span class="c1"># it must be present in the user&#39;s torch.nn.Module. Forward the call to</span>
            <span class="c1"># the user&#39;s model.</span>
            <span class="k">assert</span> <span class="s2">&quot;_torch_module&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span> <span class="s2">&quot;ORTModule does not have a reference to the user&#39;s model&quot;</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ORTModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__getattr__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="c1"># If the name is an attribute of ORTModule, update only ORTModule</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">elif</span> <span class="s2">&quot;_is_initialized&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;_is_initialized&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>

            <span class="k">assert</span> <span class="s2">&quot;_torch_module&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span> <span class="s2">&quot;ORTModule does not have a reference to the user&#39;s model&quot;</span>

            <span class="c1"># If the name is an attribute of user model, or is a new attribute, update there.</span>
            <span class="c1"># Set the attribute on the user&#39;s original module</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="c1"># Signal to execution manager to re-export the model.</span>
            <span class="c1"># Re-export will be avoided if _skip_check is enabled.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="p">,</span> <span class="n">TorchModuleORT</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">training_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_torch_module</span><span class="o">.</span><span class="n">_execution_manager</span><span class="p">(</span><span class="n">training_mode</span><span class="p">)</span><span class="o">.</span><span class="n">signal_model_changed</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Setting any new attributes should be done on ORTModule only when &#39;torch_module&#39; is not defined</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">_utils</span><span class="o">.</span><span class="n">get_state_after_deletion_of_non_ortmodule_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

        <span class="n">_utils</span><span class="o">.</span><span class="n">reinitialize_ortmodule</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright ONNX Runtime for PyTorch Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
         <script src="../../../../_static/jquery.js"></script>
         <script src="../../../../_static/underscore.js"></script>
         <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="../../../../_static/doctools.js"></script>
         <script src="../../../../_static/sphinx_highlight.js"></script>
     

  

  <script type="text/javascript" src="../../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">Stay up to date</li>
            <li><a href="https://www.facebook.com/pytorch" target="_blank">Facebook</a></li>
            <li><a href="https://twitter.com/pytorch" target="_blank">Twitter</a></li>
            <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
            <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">LinkedIn</a></li>
          </ul>  
          </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">PyTorch Podcasts</li>
            <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
            <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">Apple</a></li>
            <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">Google</a></li>
            <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">Amazon</a></li>
          </ul>
         </div>
        </div>
        
        <div class="privacy-policy">
          <ul>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">Terms</a></li>
            <li class="privacy-policy-links">|</li>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">Privacy</a></li>
          </ul>
        </div>
        <div class="copyright">
        <p>Â© Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation.
          For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see
          <a href="www.linuxfoundation.org/policies/">www.linuxfoundation.org/policies/</a>. The PyTorch Foundation supports the PyTorch open source
          project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC,
          please see <a href="www.lfprojects.org/policies/">www.lfprojects.org/policies/</a>.</p>
      </div>
     </div>

  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebookâ€™s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/hub">PyTorch Hub</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/audio/stable/index.html">torchaudio</a>
            </li>

            <li>
              <a href="https://pytorch.org/text/stable/index.html">torchtext</a>
            </li>

            <li>
              <a href="https://pytorch.org/vision/stable/index.html">torchvision</a>
            </li>

            <li>
              <a href="https://pytorch.org/serve/">TorchServe</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchx/">TorchX</a>
            </li>

            <li>
              <a href="https://pytorch.org/xla">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/resources">Developer Resources</a>
            </li>

            <li>
              <a href="https://pytorch.org/features">About</a>
            </li>

            <li>
              <a href="https://pytorch.org/hub">Models (Beta)</a>
            </li>

            <li>
              <a href="https://pytorch.org/#community-module">Community</a>
            </li>

            <li>
              <a href="https://discuss.pytorch.org/">Forums</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>